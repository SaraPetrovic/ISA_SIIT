<!DOCTYPE html>
<html>

<head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
      <meta name="description" content="">
      <meta name="author" content="">
      <link rel="icon" href="favicon.ico">
      <title>Reservation</title>
      <!-- Bootstrap core CSS -->
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <!-- materialize -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
      <link href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css" rel="stylesheet"> 
      <!-- Custom styles for this template -->
      <link href="css/jumbotron.css" rel="stylesheet">
      <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
      <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
      
      <link rel="stylesheet" href="js/seat-chart-lib/jquery.seat-charts.css">
  	  <link rel="stylesheet" href="js/seat-chart-lib/custom-style.css">
  	  <script src="js/seat-chart-lib/jquery.seat-charts.min.js"></script>
      
	  
		
</head>
<body>
	<div id="header" class="container-body" style="margin-top: 100px">
		<div class="jumbotron">
	         <div class="container">
	            <h1 id="cinema-name-header">Reservation</h1>
	            <p>Choose one or more seats you'd like to reserve</p>
	         </div>
	      </div>	
	</div>


	<div id="body">
	
		<div id="seat-map">
		
		</div>
		<hr>
		<button class="btn btn-primary">Next</button>
	</div>

<script>
	var getUrlParameter = function getUrlParameter(sParam) {
	    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
	        sURLVariables = sPageURL.split('&'),
	        sParameterName,
	        i;
	
	    for (i = 0; i < sURLVariables.length; i++) {
	        sParameterName = sURLVariables[i].split('=');
	
	        if (sParameterName[0] === sParam) {
	            return sParameterName[1] === undefined ? true : sParameterName[1];
	        }
	    }
	};
	
	var projectionID = getUrlParameter('id');
	alert(projectionID);
	
	
	var maxRow = 0;
	var maxCol = 0;
	
	// ovde ide ajax poziv da dobavim projekciju->sve karte od te projekcije
	// da bih imao sva zauzeta mesta
	// i maxrow i maxCol budu iz te projekcije
	$.ajax({
		type: "GET",
		url: "/api/projections/" + projectionID,
		success: function(projection) {	
			maxRow = projection.hall.maxRow;
			maxCol = projection.hall.maxColumn;
		},
		error: function() {alert("nije uspeo ajax za dobavljanje projekcije");},
		contentType: "application/json",
		processData: false,
		async: false
	});

	var allTickets = [];
	$.ajax({
		type: "GET",
		url: "/api/projections/" + projectionID + "/tickets",
		success: function(tickets) {
			if (tickets.length > 0) {
				$.each(tickets, function(i, ticket){
					var t = {red: -1, col: -1};
					t.red = ticket.red;
					t.col = ticket.kolona;
					allTickets.push(t);
				});
			}
		},
		error: function() {
			alert("nije uspeo ajax za dobavljanje karata");
		},
		contentType: "application/json",
		processData: false,
		async: false
	})

	var rows = [];
	var c = "";
	for (var i = 0; i < maxRow; i++) {
	  rows[i] = "";
	  for (var j=0; j< maxCol; j++) {
	    rows[i] += 'a';
	  }
	}
	
	
	var reservedSeats = generateReservedSeats(allTickets);
	alert(JSON.stringify(reservedSeats));
	var firstSeatLabel = 1;
	
	$(document).ready(function() {
	  var sc = $('#seat-map').seatCharts({
	    map: rows,
	    seats: {
	      a: {
	          price: 99.99,
	          description: 'Fair seat price',
	          classes: 'first-class'
	      }
	    },
	    naming: {
	      top: false,
	      getLabel: function(character, row, column) {
	        return firstSeatLabel++;
	      }
	      
	    },
	    
	    click: function() {
	
	      var sel = sc.find('selected');
	      alert(JSON.stringify(sel.seatIds));
	      
	      if (this.status() == 'available') {
	        return 'selected';
	      } else if (this.status() == 'selected') {
	        return 'available';
	      } else if (this.status() == 'unavailable') {
	        return 'unavailable';
	      } else {
	        return this.style();
	      }
	      
	    }
	  });
	  //alert(reservedSeats);
	  sc.get(reservedSeats).status('unavailable');
	
	});
	
	
	
	function generateReservedSeats(taken) {
	  var temp = "";
	  var ret = [];
	  for (var i = 0; i < taken.length; i++) {
	    temp+= taken[i].red + "_" + taken[i].col;
	    ret.push(temp);
	    temp = "";
	  }
	
	  return ret;
	}
	

</script>

</body>
</html>