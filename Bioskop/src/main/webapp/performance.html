<!DOCTYPE html>
<html>

<head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
      <meta name="description" content="">
      <meta name="author" content="">
      <link rel="icon" href="favicon.ico">
      <title>Performance</title>
      <!-- Bootstrap core CSS -->
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <!-- materialize -->
      
      <link href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css" rel="stylesheet"> 
      <!-- Custom styles for this template -->
      <link href="css/jumbotron.css" rel="stylesheet">
      <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
      <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>	
      <link rel="stylesheet" href="js/jquery.rateyo-lib/jquery.rateyo.css">
      
      <style>
      	#performance-details {
      		font-size: 15px;
      		font-weight: 600;
      	}
      
      </style>
      
</head>

<body>
	<script src="js/jquery.rateyo-lib/jquery.rateyo.js"></script>
	
	<div id="header" class="container-body" style="margin-top: 100px">
		<div class="jumbotron">
	         <div class="container">
	            <h1 id="performance-name-header"></h1>
	            <div id="rating"></div>
	         </div>
	      </div>	
	</div>
	
	<div id="body">
		<div id="performance-details" class="well">
			
		</div>
		<div id="performance-panels">
			
			
		</div>
	
	</div>

</body>

<script>
	var getUrlParameter = function getUrlParameter(sParam) {
	    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
	        sURLVariables = sPageURL.split('&'),
	        sParameterName,
	        i;
	
	    for (i = 0; i < sURLVariables.length; i++) {
	        sParameterName = sURLVariables[i].split('=');
	
	        if (sParameterName[0] === sParam) {
	            return sParameterName[1] === undefined ? true : sParameterName[1];
	        }
	    }
	};
	
	
	var performanceID = "";
	var theaterID = "";
	var performanceRating = 0;
	$(document).ready(function(){
		performanceID = getUrlParameter('performanceid');
		theaterID = getUrlParameter('theaterid');
		var body  = '';
		// dobavi bioskop
		$.ajax({
			type: "GET",
			url: "/api/movies/" + performanceID,
			success: function(performance) {	
				$("#performance-name-header").text(performance.name);
				performanceRating = performance.averageRating;
				body += '<p>Genre: ' + performance.type + '</p>';
				body += '<p>Cast: ' + performance.actors + '</p>';
				body += '<p>Producer: ' + performance.producer + '</p>';
				body += '<p>Runntime: ' + performance.filmDuration + 'min</p>';
				body += '<p>Description: ' + performance.description + '</p>';
				
				$("#performance-details").append(body);
				
			},
			error: function() {alert("nije uspeo ajax za dobavljanje predstave");},
			contentType: "application/json",
			processData: false,
			async: false
		});
		
		
		// postavi rating
		$("#rating").rateYo({
		    starWidth: "40px",
		    readOnly: true,
		    rating: performanceRating,
		  });
		
		
		var sortedProjections = {};
		
		$.ajax({
			type: "GET",
			url: "/api/TheaterOrCinema/" + theaterID + "/projections",
			contentType: "application/json",
			processData: false,
			async: false,
			success: function(projections) {
				if(projections == null){
					// ovde uradi neki alert i redirect
					alert("performanceses returned null!");
				}
				var performanceName = '';
				$.each(projections, function(i, projection){
					performanceName = projection.movieOrPerformance.name;
					if (sortedProjections.hasOwnProperty(performanceName)) {
						sortedProjections[performanceName].push(projection);
					} else {
						sortedProjections[performanceName] = [];
						sortedProjections[performanceName].push(projection);
					}
					
				});
				
			},
			error: function() {
				alert("ERR getting theaters performanceses");
			}
		});
		
		
		var body = '';
		for (var key in sortedProjections) {
			if (sortedProjections.hasOwnProperty(key)) {
				body += '<div class="col-md-12">';
				body +=	  '<div class="panel panel-primary">';
				body +=	     '<div class="panel-heading">';
				body +=	         '<h2 class="panel-title">' + "Performanceses" + '</h2>';
				body +=      '</div>';
				body +=      '<div class="panel-body">';
				
				for (var i = 0; i < sortedProjections[key].length; i++) {
					var d = formatDate(sortedProjections[key][i].date)
					body += '<button class="btn btn-info" onclick="redirectToReservation(' + sortedProjections[key][i].id + ')" style="margin: 2px;">' + d + '</button>'	
				}
				
				body +=	     '</div>';
				body +=      '<div class="panel-footer">';
				body +=      '</div>'
				body +=   '</div>'
				body += '</div>'
				body += '<hr>';
			}
		}
		
		$("#performance-panels").append(body);
		
	});
	
	function formatDate(dateTxt) {
		var temp = dateTxt.split('T');
		var time = temp[1];
		var t = temp[0].split('-');
		var day = t[2];
		var month = t[1];
		var year = t[0];
		var dateStr = "";
		dateStr = day + "." + month + "." + year + ".<br/> " + time; 
		return dateStr;
	};
	
	function redirectToReservation(performanceID) {
		var redirectLoc = "/reservation.html?id=" + performanceID;
		window.location.href = redirectLoc;
	}
	
</script>

</html>